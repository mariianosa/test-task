{% liquid
  assign p = product | default: closest.product
  assign refs = null
  if p and p.metafields.custom and p.metafields.custom.accordion_items != blank
    assign refs = p.metafields.custom.accordion_items.value
  endif
%}

{%- capture _rendered_items -%}
  {%- for entry in refs -%}
    {%- assign title = entry.accordion_title.value
      | default: entry.accordion_title
      | default: entry.fields.accordion_title.value -%}

    {%- capture content_html -%}
      {%- if entry.accordion_content -%}
        {{ entry.accordion_content | metafield_tag }}
      {%- elsif entry.fields and entry.fields.accordion_content -%}
        {{ entry.fields.accordion_content | metafield_tag }}
      {%- endif -%}
    {%- endcapture -%}

    {%- assign content_stripped = content_html | strip -%}
    {%- if title != blank and content_stripped != blank -%}
      {% assign ctrl_id = 'acc-' | append: section.id | append: '-' | append: forloop.index %}
      <div class="p-accordion__item">
        <button class="p-accordion__trigger"
                aria-expanded="false"
                aria-controls="{{ ctrl_id }}"
                id="{{ ctrl_id }}-btn"
                type="button">
          <span class="p-accordion__title">{{ title }}</span>
          <span class="p-accordion__icon" aria-hidden="true">▾</span>
        </button>
        <div class="p-accordion__panel"
             id="{{ ctrl_id }}"
             role="region"
             aria-labelledby="{{ ctrl_id }}-btn"
             hidden>
          <div class="p-accordion__content rte">
            {{ content_html }}
          </div>
        </div>
      </div>
    {%- endif -%}
  {%- endfor -%}
{%- endcapture -%}

{%- assign _rendered_items_stripped = _rendered_items | strip -%}
{%- if _rendered_items_stripped != blank -%}
  <section class="p-accordion-section" data-allow-multiple="{{ section.settings.allow_multiple }}">
    {% if section.settings.heading != blank %}
      <h2 class="p-accordion__heading">{{ section.settings.heading }}</h2>
    {% endif %}
    <div class="p-accordion" id="p-accordion-{{ section.id }}">
      {{ _rendered_items }}
    </div>
  </section>

  <style>
    .p-accordion-section {
      margin-block: 24px;
    }
    .p-accordion__heading {
      margin-bottom: 12px;
      font-size: 1.25rem;
    }
    .p-accordion__trigger {
      margin: auto;
      padding: auto;
      width: 80%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      background: none;
      border: 0;
      cursor: pointer;
    }
    .p-accordion__icon {
      transition: transform 0.2s ease;
    }
    .p-accordion__trigger[aria-expanded='true'] .p-accordion__icon {
      transform: rotate(180deg);
    }
    .p-accordion__panel {
      padding: 3px 125px 12px;
    }
  </style>

  <script>
    (() => {
      const container = document.getElementById('p-accordion-{{ section.id }}');
      if (!container) return;

      const sectionEl = container.closest('.p-accordion-section');
      const allowMultiple = sectionEl && sectionEl.dataset.allowMultiple === 'true';

      container.addEventListener('click', (e) => {
        const btn = e.target.closest('.p-accordion__trigger');
        if (!btn || !container.contains(btn)) return;

        const item = btn.closest('.p-accordion__item');
        const panel = item && item.querySelector('.p-accordion__panel');
        if (!panel) return;

        const isOpen = btn.getAttribute('aria-expanded') === 'true';

        if (!allowMultiple) {
          container.querySelectorAll('.p-accordion__trigger[aria-expanded="true"]').forEach((openBtn) => {
            if (openBtn !== btn) {
              openBtn.setAttribute('aria-expanded', 'false');
              const p = document.getElementById(openBtn.getAttribute('aria-controls'));
              if (p) p.hidden = true;
            }
          });
        }

        btn.setAttribute('aria-expanded', String(!isOpen));
        panel.hidden = isOpen;
      });
    })();
  </script>
{%- endif -%}

{% schema %}
{
  "name": "Product accordion",
  "tag": "section",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Додаткова інформація" },
    { "type": "checkbox", "id": "allow_multiple", "label": "Дозволити відкривати кілька", "default": false }
  ],
  "presets": [{ "name": "Product accordion (metaobject)" }]
}
{% endschema %}
